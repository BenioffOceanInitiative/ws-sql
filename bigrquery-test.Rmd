---
title: "bigrquery-test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Reference: [bigrquery.r-dbi.org](https://bigrquery.r-dbi.org)

## Authorize attempt 1

For non-interactive usage, using:

- [ships4whales@benioff-ocean-initiative.iam.gserviceaccount.com](https://console.cloud.google.com/iam-admin/serviceaccounts/details/114569616080626900590?authuser=3&project=benioff-ocean-initiative)

### sidenote: alternate account

- [whalesafe_table_updater – IAM & Admin – Benioff Ocean Initi… – Google Cloud Platform](https://console.cloud.google.com/iam-admin/serviceaccounts/details/108185723528190775192?authuser=3&project=benioff-ocean-initiative)

- Service account token, per [How to get your own API credentials • gargle](https://gargle.r-lib.org/articles/get-api-credentials.html#service-account-token)
  - From the Developers Console, in the target GCP Project, go to IAM & Admin > Service accounts
  - whalesafe_table_updater > KEYS menu > ADD KEY button
  - Downloaded [benioff-ocean-initiative-b208e85608c2.json](https://drive.google.com/open?id=1ClWXfMMVxufY4-_EPyOj2hHnC4dU3qtS&authuser=ben%40ecoquants.com&usp=drive_fs) into [gfw - Google Drive](https://drive.google.com/drive/u/3/folders/1crBGnOPGiKdWbtOLQhzgdJKA1ztZBzTM) and uploaded into server `/home/admin`

```{r}
library(bigrquery)

# ships4whales@benioff-ocean-initiative.iam.gserviceaccount.com
auth_json = '/home/admin/Benioff Ocean Initiative-454f666d1896.json'
bq_auth(path = auth_json)
```


```{r}
(projects <- bq_projects())
prj <- projects[[1]]
bq_project_datasets(prj)
jobs <- try(bq_project_jobs(prj))
jobs[1:3]
```

```{r}
sql <- "SELECT year, month, day, weight_pounds FROM `publicdata.samples.natality`"

tb <- try(bq_project_query(prj, sql))
if (!"try-error" %in% class(tb))
   try(bq_table_download(tb, max_results = 10))
```

## DBI

- [db.rstudio.com/databases/big-query](https://db.rstudio.com/databases/big-query/)

```{r}
library(DBI)

con <- dbConnect(
  bigrquery::bigquery(),
  project = "benioff-ocean-initiative",
  dataset = "whalesafe_v3",
  billing = "benioff-ocean-initiative")
con
```

## Connections

- [RStudio Connections Pane](https://db.rstudio.com/rstudio/connections/)

```{r}
library(connections)
library(bigrquery)

con <- connection_open(
  bigrquery::bigquery(),
  project = "benioff-ocean-initiative",
  dataset = "whalesafe_v3",
  billing = "benioff-ocean-initiative",
  use_legacy_sql = FALSE)
```


Except cannot expand tables to see columns: R Code Execution Error.

eval=F:
```{r, eval=F}
connection_close(con)
```

## Chunks

* [Using SQL in RStudio](https://irene.rbind.io/post/using-sql-in-rstudio/)

```{sql connection=con, eval=F}
SELECT * FROM ais_segments LIMIT 10;
```
```
Error: Cannot query over table 'ais_data' without a filter over column(s) 'timestamp' that can be used for partition elimination [invalidQuery]
In addition: Warning message:
In class(obj) <- c("scalar", class(obj)) :
  Setting class(x) to multiple strings ("scalar", "SQL", ...); result will no longer be an S4 object
Failed to execute SQL chunk
```

```{sql connection=con, eval=F}
SELECT * FROM ais_segments 
WHERE DATE(timestamp) > (CURRENT_DATE() - 7)
LIMIT 10;
```

```
Running job 'benioff-ocean-initiative.job_QNlp_dzhVrQ38KoJgTf8hFxIZ-3f.US' [|]  1s
Complete
Billed: 13.63 MB
Downloading 10 rows in 1 pages.
Error in bq_parse_files(schema_path, page_paths, n = page_info$n_rows,  : 
  Unknown type GEOGRAPHY
In addition: Warning message:
In class(obj) <- c("scalar", class(obj)) :
  Setting class(x) to multiple strings ("scalar", "SQL", ...); result will no longer be an S4 object
Failed to execute SQL chunk
```

```{sql connection=con}
SELECT * FROM whalesafe_v3.INFORMATION_SCHEMA.TABLES ORDER BY table_name;
```

```{sql connection=con}
SELECT
 -- * 
 -- EXCEPT(is_generated, generation_expression, is_stored, is_updatable)
 data_type, column_name, is_partitioning_column
FROM
 whalesafe_v3.INFORMATION_SCHEMA.COLUMNS
WHERE
 table_name="ais_segments"
ORDER BY
 data_type, column_name;
```

```{sql connection=con}
SELECT * EXCEPT(linestring, point)
FROM ais_segments 
WHERE DATE(timestamp) > (CURRENT_DATE() - 7)
ORDER BY timestamp DESC
LIMIT 10;
```
