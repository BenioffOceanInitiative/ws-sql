---
title: "us_vsr_geojson"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## US VSR (vessel strike restrictions) zone data scraper

See [US VSR zone data scraper · Issue #2 · BenioffOceanInitiative/ws-sql](https://github.com/BenioffOceanInitiative/ws-sql/issues/2)

```{r warning=F}
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}
shelf(
  # geojsonio,
  geojsonsf,
  dplyr,
  glue,
  here,
  # RCurl,
  purrr,
  sf,
  tidyr,
  # tidyverse,
  # XML,
  xml2)
# library(RJSONIO)

url <- "https://apps-nefsc.fisheries.noaa.gov/cgi-bin/mammalmaps/xmlgenDMA.pl"
x   <- read_xml(url) # alternative method of reading 

nodes <- xml_find_all(x, "//dma")

d <- nodes %>% 
  xml_attrs() %>% 
  map_df(~as.list(.))

waypoints <- map_df(d$id, function(id){
  nodes %>% 
    # xml_find_first(glue("//dma[@id='{id}']/child::node()")) %>% 
    # use xml_find_all to prevent duplicating same lat/lng value
    xml_find_all(glue("//dma[@id='{id}']/child::node()")) %>% 
    xml_attrs() %>%
    # duplicate first lat/lon values for creating polygons
    bind_cols(.[[1]]) %>% 
    map_df(~as.list(.)) %>%
    mutate(
      id = !!id) }) %>% nest(waypoints = any_of(c("lon","lat"))) 

d <- d %>% 
  left_join(
    waypoints,
    by = "id") 

sf <- map2_df(d$id, d$waypoints, function(id, waypoints){
  waypoints %>% 
    as_tibble() %>% 
    st_as_sf(coords = c("lat", "lon"), crs = 4326) %>% 
    summarize(sfc_geometry = st_combine(geometry)) %>% 
    st_cast("POLYGON") %>% 
    map_df(~as.list(.)) %>% 
    mutate(id = !!id) })

d <- d %>%
  left_join(sf, by = "id") %>% 
  mutate(geojson = sfc_geometry %>% sfc_geojson())
```

